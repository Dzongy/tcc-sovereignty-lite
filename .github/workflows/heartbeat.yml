name: ZENITH Heartbeat
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: ZENITH Autopilot Tick
        run: |
          echo "Triggering ZENITH autopilot..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://tcc-zenith-brain.onrender.com/api/zenith/autopilot \
            -H "Content-Type: application/json" \
            -d '{}' \
            --max-time 120)
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" -ge 500 ]; then
            echo "Warning: Autopilot returned server error, continuing with heartbeat..."
          fi

      - name: Update zenith-memory.json
        run: |
          FILE="zenith-memory.json"
          if [ ! -f "$FILE" ]; then
            echo "Memory file missing, skipping"
            exit 0
          fi
          # Read current version
          CURRENT=$(cat "$FILE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('version','5.0.0'))")
          # Increment patch
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          # Get timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Update file
          python3 -c "
          import json
          with open('$FILE','r') as f:
              d = json.load(f)
          d['version'] = '${NEW_VERSION}'
          d['last_heartbeat'] = '${TIMESTAMP}'
          d['heartbeat_source'] = 'github_actions_cron'
          with open('$FILE','w') as f:
              json.dump(d, f, indent=2)
          "
          echo "Updated to v${NEW_VERSION} at ${TIMESTAMP}"

      - name: Commit and push
        run: |
          git config user.name "ZENITH Heartbeat"
          git config user.email "zenith@tcc.sovereign"
          git add zenith-memory.json
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "heartbeat: v$(cat zenith-memory.json | python3 -c \"import sys,json; print(json.load(sys.stdin).get('version','?'))\") â€” ZENITH pulse"
          git push
