name: Zenith Thinking Loop
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
jobs:
  think:
    runs-on: ubuntu-latest
    steps:
      - name: Wake Render
        run: curl -s -o /dev/null -w "%{http_code}" https://tcc-zenith-brain.onrender.com/api/health || true
      - name: Wait for cold start
        run: sleep 20
      - name: Trigger autopilot and save memory
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d '{}' -m 120 https://tcc-zenith-brain.onrender.com/api/zenith/autopilot)
          echo "Response received: $(echo "$RESPONSE" | head -c 200)"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "Autopilot failed or no success field"
            exit 0
          fi
          MEMORY=$(echo "$RESPONSE" | jq '.memory')
          if [ "$MEMORY" = "null" ] || [ -z "$MEMORY" ]; then
            echo "No memory in response, skipping write"
            exit 0
          fi
          echo "$MEMORY" > /tmp/zenith-memory.json
          SHA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/Dzongy/tcc-sovereignty-lite/contents/zenith-memory.json" | jq -r '.sha')
          CONTENT=$(base64 -w 0 /tmp/zenith-memory.json)
          curl -s -X PUT -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/Dzongy/tcc-sovereignty-lite/contents/zenith-memory.json" \
            -d "{\"message\":\"Thinking loop: memory sync $(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"content\":\"$CONTENT\",\"sha\":\"$SHA\"}"
          echo "Memory committed to GitHub"
