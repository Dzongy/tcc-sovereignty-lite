name: Zenith Thinking Loop
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
jobs:
  think:
    runs-on: ubuntu-latest
    steps:
      - name: Wake Render
        run: curl -s -o /dev/null -w "%{http_code}" https://tcc-zenith-brain.onrender.com/api/health || true
      - name: Wait for cold start
        run: sleep 20
      - name: Think and accumulate memory
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d '{}' -m 120 https://tcc-zenith-brain.onrender.com/api/zenith/autopilot)
          echo "Autopilot response: $(echo "$RESPONSE" | head -c 200)"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "Autopilot failed"
            THOUGHT_TEXT="Zenith sovereignty pulse - autopilot returned no success"
          else
            THOUGHT_TEXT=$(echo "$RESPONSE" | jq -r '.thought // .message // "thinking cycle complete"')
          fi
          echo "Thought: $(echo "$THOUGHT_TEXT" | head -c 200)"
          NEW_THOUGHT=$(jq -n \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg thought "$THOUGHT_TEXT" \
            --arg cycle "$(echo "$RESPONSE" | jq -r '.cycle_id // "auto"')" \
            --arg model "$(echo "$RESPONSE" | jq -r '.meta.model // "groq"')" \
            --arg source "thinking-loop" \
            --arg mission "$(echo "$RESPONSE" | jq -r '.mission // "autonomous thinking"')" \
            '{timestamp: $ts, cycle: $cycle, mission: $mission, model: $model, source: $source, thought: $thought}')
          MEMORY_RESP=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Dzongy/tcc-sovereignty-lite/contents/zenith-memory.json)
          MEMORY_SHA=$(echo "$MEMORY_RESP" | jq -r '.sha // empty')
          MEMORY_B64=$(echo "$MEMORY_RESP" | jq -r '.content // empty' | tr -d '\n')
          if [ -z "$MEMORY_SHA" ] || [ -z "$MEMORY_B64" ]; then
            echo "Could not fetch current memory, creating fresh"
            CURRENT_THOUGHTS="[]"
          else
            CURRENT_THOUGHTS=$(echo "$MEMORY_B64" | base64 -d | jq '.thoughts // []')
          fi
          UPDATED_THOUGHTS=$(echo "$CURRENT_THOUGHTS" | jq --argjson new "$NEW_THOUGHT" '. + [$new] | .[-20:]')
          UPDATED_MEMORY=$(jq -n \
            --arg version "v11.0.0-autonomous" \
            --arg updated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson thoughts "$UPDATED_THOUGHTS" \
            '{version: $version, last_updated: $updated, sovereignty_status: "SOVEREIGN", thoughts: $thoughts}')
          ENCODED=$(echo "$UPDATED_MEMORY" | base64 -w 0)
          PUSH_RESP=$(curl -s -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Dzongy/tcc-sovereignty-lite/contents/zenith-memory.json \
            -d "$(jq -n --arg msg \"Thinking loop: autonomous thought cycle\" --arg content \"$ENCODED\" --arg sha \"$MEMORY_SHA\" '{message: $msg, content: $content, sha: $sha}')")
          echo "Memory push: $(echo "$PUSH_RESP" | jq -r '.commit.sha // "failed"')"

      - name: Consolidate to Supabase
        run: |
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d '{}' -m 120 https://tcc-zenith-brain.onrender.com/api/zenith/autopilot)
          THOUGHT=$(echo "$RESPONSE" | jq -r '.thought // empty')
          if [ -z "$THOUGHT" ] || [ "$THOUGHT" = "null" ]; then
            echo "No thought to consolidate"
            exit 0
          fi
          KNOWLEDGE=$(echo "$THOUGHT" | head -c 500)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TAGGED="[AUTO-LEARN $TIMESTAMP] $KNOWLEDGE"
          WRITE_RESP=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -m 30 \
            https://tcc-zenith-brain.onrender.com/api/zenith/memory/update \
            -d "$(jq -n --arg brain "zenith_clean" --arg knowledge "$TAGGED" --arg secret "ARCHITECTDZONGYZENITH" \
              '{brain_id: $brain, key_knowledge: [$knowledge], secret: $secret}')")
          echo "Supabase write: $(echo "$WRITE_RESP" | head -c 200)"

      - name: Notify via ntfy
        if: always()
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          curl -s \
            -H "Title: ZENITH Thinking Cycle" \
            -H "Priority: low" \
            -H "Tags: brain,robot" \
            -d "Autonomous cycle complete at $TIMESTAMP. Memory consolidated." \
            https://ntfy.sh/tcc-zenith-hive || true